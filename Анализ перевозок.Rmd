---
title: "Анализ временных рядов авиаперевозок AirFrance"
author: "Бэлла Долганова"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
---
# Предисловие
Настоящий отчет посвящен углубленному анализу и прогнозированию операционных показателей авиакомпании AirFrance. В условиях высокой волатильности рынка авиаперевозок, понимание внутренней структуры данных - тренда, сезонных циклов и характера случайных колебаний — является критически важным для эффективного управления ресурсами и планирования маркетинговых активностей. 

Целью данной работы является построение математической модели, способной с высокой точностью предсказывать будущий пассажиропоток, учитывая сложную сезонную составляющую и динамику роста компании. В ходе исследования последовательно решаются задачи стабилизации дисперсии, проверки данных на стационарность и подбора оптимальных параметров модели группы ARIMA.
# Диагностика (анализ) подбираемой модели
## STL-декомпозиция: структурный анализ (аддитивная модель)

### Что проверяем

Для анализа структуры временного ряда применяется метод STL (Seasonal and Trend decomposition using Loess).  
Он позволяет разделить данные на три компоненты:

- **Trend** — долгосрочное направление развития,
- **Seasonal** — повторяющиеся сезонные колебания,
- **Remainder** — случайные отклонения (шум).

Такой подход помогает понять, насколько корректно аддитивная модель описывает поведение пассажиропотока.
```{r setup_data, include=FALSE}
# ==========================================
# 2. Подготовка данных
# ==========================================

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(lubridate)
library(dplyr)
library(ggplot2)
library(forecast)
library(tidyr)
library(FinTS)
```
```{r}

# --- 2.1 Загрузка данных ---
airfrance_data <- read.csv("var7.csv", sep = ";", stringsAsFactors = FALSE)
```
```{r}

# --- 2.2 Создание колонки Date ---
airfrance_data$Date <- as.Date(
  paste0(as.character(airfrance_data$Activity.Period), "01"),
  format = "%Y%m%d"
)
airfrance_data$Activity.Period <- NULL
colnames(airfrance_data) <- c("Airline", "Passengers", "Date")
```
```{r}
# --- 2.3 Преобразование в ts объект ---
passengers_ts <- ts(
  airfrance_data$Passengers,
  start = c(year(min(airfrance_data$Date)), month(min(airfrance_data$Date))),
  frequency = 12
)
```
```{r}
# STL-декомпозиция (аддитивная модель)

# 1. Построение STL
stl_add <- stl(passengers_ts, s.window = "periodic")

# 2. Визуализация компонент
autoplot(stl_add) +
  theme_minimal() +
  labs(
    title = "STL-декомпозиция (аддитивная модель)",
    subtitle = "Разложение временного ряда на тренд, сезонность и остатки",
    x = "Год",
    y = "Количество пассажиров"
  )

# 3. Оценка доли остаточного шума
residual_var_add <- var(stl_add$time.series[, "remainder"])
signal_var_add <- var(stl_add$time.series[, "trend"] +
                      stl_add$time.series[, "seasonal"])

relative_noise_add <- residual_var_add / signal_var_add
relative_noise_add
```

### Что показывает график

1. **Устойчивый восходящий тренд.**  
   На панели *Trend* наблюдается стабильный рост пассажиропотока в течение всего периода (2005–2016 гг.), что подтверждает масштабирование бизнеса.

2. **Рост амплитуды остатков.**  
   На панели *Remainder* заметно, что разброс случайных отклонений увеличивается ближе к концу периода.  
   В 2014–2016 гг. ошибки существенно выше, чем в начале ряда.

3. **Количественная оценка.**  
   Относительный уровень шума составляет около **15% (0.149)**.  
   Это означает, что аддитивная модель оставляет значительную долю необъяснённой вариации.

### Вывод

- Аддитивная модель предполагает фиксированную прибавку сезонного эффекта каждый год.  
  Однако фактические данные демонстрируют пропорциональный (процентный) рост сезонных пиков.

- Уровень шума около 15% увеличивает неопределённость прогноза.  
  Для авиакомпании это может означать либо недозагрузку рейсов, либо нехватку мощностей в пиковые месяцы.

- Полученный результат служит обоснованием перехода к мультипликативной модели (логарифмической трансформации), которая позволяет снизить долю шума и повысить точность планирования ресурсов.

```{r}
# ==========================================
# STL-декомпозиция (мультипликативная модель, log)
# ==========================================

# 1. Логарифмирование ряда
log_passengers_ts <- log(passengers_ts)

# 2. Построение STL
stl_log <- stl(log_passengers_ts, s.window = "periodic")

# 3. Визуализация компонент
autoplot(stl_log) +
  theme_minimal() +
  labs(
    title = "STL-декомпозиция (мультипликативная модель, log)",
    subtitle = "Разложение логарифмированного ряда на тренд, сезонность и остатки",
    x = "Год",
    y = "Log(Количество пассажиров)"
  )

# 4. Оценка доли остаточного шума
residual_var_log <- var(stl_log$time.series[, "remainder"])
signal_var_log <- var(stl_log$time.series[, "trend"] +
                      stl_log$time.series[, "seasonal"])

relative_noise_log <- residual_var_log / signal_var_log
relative_noise_log
```
## Сравнительный анализ: аддитивная и мультипликативная модели

Ключевое различие моделей связано с трактовкой сезонности.  
Аддитивная модель предполагает постоянную амплитуду сезонных колебаний во времени.  
Мультипликативный подход (через логарифмирование) учитывает пропорциональный характер изменений — рост сезонных пиков вместе с увеличением общего уровня пассажиропотока.

В аддитивной декомпозиции наблюдается увеличение разброса остатков к концу периода.  
Относительный уровень шума составляет около **0.15**, что указывает на снижение качества описания ряда по мере роста компании.

После логарифмической трансформации амплитуда сезонных колебаний стабилизируется, а остаточная вариация сокращается.  
Относительный шум уменьшается более чем в два раза — до **0.07**, что свидетельствует о более корректной спецификации модели.

Таким образом, динамика пассажиропотока AirFrance носит пропорциональный характер - сезонные эффекты масштабируются вместе с уровнем спроса, а не добавляются фиксированной величиной.

# Анализ сезонной динамики

### График 1. Исходный ряд

На графике сезонные профили разных лет наложены друг на друга, что позволяет оценить характер колебаний внутри года.

В низкий сезон (январь, февраль, ноябрь) линии располагаются близко друг к другу.  
В пиковые месяцы (июль–август) расстояние между ними существенно увеличивается.

Это указывает на рост амплитуды колебаний по мере увеличения общего уровня пассажиропотока.  
Абсолютный прирост в высокий сезон значительно выше, чем в периоды низкого спроса.  
Таким образом, вариация зависит от масштаба ряда, что ограничивает применимость аддитивной модели.

```{r}
# ==========================================
# Сезонный анализ: ggseasonplot
# ==========================================

# 1. Сезонный график исходного ряда
ggseasonplot(passengers_ts,
             year.labels = TRUE,
             year.labels.left = TRUE) +
  theme_minimal() +
  labs(
    title = "Сезонная динамика пассажиропотока (исходные данные)",
    subtitle = "Сравнение сезонных профилей по годам",
    x = "Месяц",
    y = "Количество пассажиров"
  )
```
### График 2. Логарифмированный ряд

После логарифмической трансформации структура сезонных профилей становится более однородной.

Расстояние между линиями разных лет визуально стабилизируется как в периоды низкого, так и высокого спроса.  
Сезонный паттерн сохраняет форму и масштабируется пропорционально тренду.

Это свидетельствует о стабилизации дисперсии и корректности мультипликативного подхода к моделированию.
```{r}

# 2. Сезонный график логарифмированного ряда
ggseasonplot(log_passengers_ts,
             year.labels = TRUE,
             year.labels.left = TRUE) +
  theme_minimal() +
  labs(
    title = "Сезонная динамика пассажиропотока (log-преобразование)",
    subtitle = "Стабилизация амплитуды сезонных колебаний",
    x = "Месяц",
    y = "Log(Количество пассажиров)"
  )
```

---

### Вывод

Сезонный профиль стабилен во времени: пик спроса систематически приходится на летние месяцы, минимальные значения — на начало года. Смещения сезонных максимумов не наблюдается, что упрощает планирование мощностей и загрузки.

Использование логарифмической модели позволяет корректно учитывать процентный рост спроса и снижает риск недооценки потребности в ресурсах в периоды пиковых нагрузок.

# Проверка стационарности логарифмированного ряда

### Цель этапа

Для корректного применения моделей класса ARIMA временной ряд должен быть стационарным либо приведён к стационарному виду.  
Стационарность предполагает неизменность математического ожидания и дисперсии во времени.  
Для оценки выполняется проверка двумя взаимодополняющими тестами: ADF и KPSS.

---

### Результаты тестирования

**1. Тест Дики-Фуллера (ADF)**  
Нулевая гипотеза H0: ряд содержит единичный корень (нестационарен).

Результат:  
Dickey-Fuller = -9.9446  
p-value = 0.01  

Интерпретация:  
Так как p-value < 0.05, нулевая гипотеза отвергается.  
Это свидетельствует об отсутствии единичного корня. После логарифмирования стохастический тренд существенно ослаблен.

```{r stationarity_tests, echo=FALSE}
# ==========================================
# Проверка стационарности логарифмированного ряда
# ==========================================

library(tseries)

# --- 1. ADF-тест (нулевая гипотеза: ряд НЕстационарен) ---
adf_result <- adf.test(log_passengers_ts)
```
```{r}

# --- 2. KPSS-тест (нулевая гипотеза: ряд стационарен) ---
kpss_result <- kpss.test(log_passengers_ts)

# Вывод результатов тестов
adf_result
kpss_result
```
---

**2. Тест KPSS**  
Нулевая гипотеза H0: ряд стационарен.

Результат:  
KPSS Level = 0.47811  
p-value = 0.0466  

Интерпретация:  
p-value < 0.05, следовательно, нулевая гипотеза отвергается.  
Это указывает на наличие детерминированной структуры (тренд или сезонность), которая не устранена полностью логарифмической трансформацией.
---

### Вывод

Полученные результаты указывают на наличие дифференцируемой нестационарности (difference stationarity):

- ADF подтверждает отсутствие стохастического тренда;
- KPSS фиксирует сохранение детерминированной компоненты.

Следовательно, для построения модели необходимо выполнить дифференцирование:

- d = 1 — устранение тренда,
- D = 1 — устранение сезонной компоненты.

Таким образом, корректной спецификацией будет модель SARIMA(p, d, q)(P, D, Q), а не ARMA.

# Итоговая проверка стационарности  
Валидация трансформированного ряда `diff_log_seasonal`

### Цель этапа

После логарифмирования (стабилизация дисперсии) и последующего регулярного и сезонного дифференцирования необходимо подтвердить, что полученный ряд является стационарным.  
Стационарность означает отсутствие тренда и сезонной структуры, а также неизменность статистических характеристик во времени.  
Для проверки используются два взаимодополняющих теста.

### Результаты тестирования

**1. Тест Дики–Фуллера (ADF)**  
Нулевая гипотеза H₀: ряд нестационарен (присутствует единичный корень).

Результат: Dickey-Fuller = -7.2471, p-value = 0.01.

Интерпретация: при p-value < 0.05 нулевая гипотеза отвергается.  
Тест подтверждает отсутствие стохастического тренда в трансформированном ряду.

**2. Тест KPSS**  
Нулевая гипотеза H₀: ряд стационарен.

Результат: KPSS Level = 0.028, p-value = 0.1.

Интерпретация: при p-value ≥ 0.05 отсутствуют основания отвергнуть гипотезу стационарности.  
В отличие от проверки исходного ряда, после преобразований тест KPSS не выявляет остаточной трендовой структуры.

```{r}
# ==========================================
# Дифференцирование логарифмированного ряда
# ==========================================

# 1. Регулярное дифференцирование (устранение тренда)
diff_log_1 <- diff(log_passengers_ts, differences = 1)

# 2. Сезонное дифференцирование (устранение сезонности, период = 12)
diff_log_seasonal <- diff(diff_log_1, lag = 12)

# 3. Визуальный анализ полученного ряда
autoplot(diff_log_seasonal) +
  theme_minimal() +
  labs(
    title = "Лог-ряд после регулярного и сезонного дифференцирования",
    subtitle = "Подготовка к моделированию SARIMA",
    x = "Год",
    y = "Дифференцированный log(пассажиры)"
  )

# ==========================================
# Повторная проверка стационарности
# ==========================================

library(tseries)

# ADF-тест
adf_result_diff <- adf.test(diff_log_seasonal)
adf_result_diff

# KPSS-тест
kpss_result_diff <- kpss.test(diff_log_seasonal)
kpss_result_diff

# ==========================================
# ACF и PACF для идентификации параметров
# ==========================================

ggAcf(diff_log_seasonal, lag.max = 48) +
  labs(title = "ACF дифференцированного ряда")

ggPacf(diff_log_seasonal, lag.max = 48) +
  labs(title = "PACF дифференцированного ряда")
```


### Вывод

Результаты ADF и KPSS согласованы: трансформированный ряд можно считать стационарным.  
Тренд и сезонность устранены, что позволяет переходить к этапу идентификации и оценки параметров модели SARIMA.


# Описание модели SARIMA

Модель прогнозирует логарифмированное число пассажиров с учётом тренда и годовой сезонности (период 12 месяцев). Использована SARIMA(2,0,2)(0,1,1) с дрейфом и Box–Cox‑преобразованием с λ = 0 (натуральный логарифм).  

- **Несезонная часть:** ARMA(2,2) — две авторегрессионные и две скользящие средние компоненты.  
- **Сезонная часть:** MA(1) с периодом 12 месяцев, учитывающая годовую цикличность.  
- Все оценённые коэффициенты (ar1, ar2, ma1, ma2, sma1) статистически значимы, что подтверждает важность краткосрочных и сезонных зависимостей.

- **Качество подгонки:** Малое значение σ² ≈ 8.64·10⁻⁵ и высокий логарифм правдоподобия свидетельствуют о точной подгонке модели к логарифмированным данным.  
- **Информационные критерии:** AIC = −749.49, AICc = −748.47, BIC = −730.16. Низкие значения указывают на оптимальный баланс между точностью и сложностью модели.

Модель может считаться одним из лучших вариантов SARIMA для анализа пассажиропотока AirFrance, обеспечивая корректное отражение как тренда, так и сезонной динамики.
```{r}
# ==========================================
# 4. Построение модели SARIMA
# ==========================================

library(forecast)

# Логарифмированный ряд уже есть: log_passengers_ts
# Сезонное дифференцирование для удаления тренда и сезонности
diff_log_seasonal <- diff(log_passengers_ts, lag = 12, differences = 1)

# Применяем auto.arima с указанием сезонности
fit_sarima <- auto.arima(
  log_passengers_ts,
  seasonal = TRUE,
  stepwise = FALSE,
  approximation = FALSE,
  lambda = 0
)

# Посмотрим параметры модели
fit_sarima
```
```{r}
### Диагностика остатков SARIMA

# 1. Графическое исследование остатков
checkresiduals(fit_sarima) +
  labs(
    title = "Анализ остатков модели SARIMA",
    subtitle = "Графики автокорреляции, остаточного шума и гистограмма ошибок"
  )

# 2. Тест Льюнга-Бокса для проверки автокорреляции
Box.test(residuals(fit_sarima), lag = 12, type = "Ljung-Box")

# 3. Проверка гетероскедастичности (ARCH-тест)
library(FinTS)
ArchTest(residuals(fit_sarima), lags = 12)

# 4. Оценка точности прогноза
accuracy(forecast(fit_sarima, h = 12))
```
## Диагностика остатков модели SARIMA

Результаты проверки остатков модели SARIMA показывают, что они ведут себя близко к «белому шуму» и не содержат признаков условной гетероскедастичности.  

- **Ljung–Box тест:**  
  - Для первых 19 лагов: Q* = 31.067, df = 19, p-value = 0.0397.  
    Отмечается слабая автокорреляция на некоторых лагах.  
  - Повторная проверка на 12 лагах: X-squared = 13.734, df = 12, p-value = 0.318.  
    Нулевую гипотезу о независимости остатков отвергнуть нельзя, что подтверждает корректность спецификации модели.

- **ARCH LM‑тест:** Chi-squared = 15.522, df = 12, p-value = 0.2141.  
  Дисперсия остатков остаётся относительно стабильной во времени, применение GARCH‑моделей не требуется.

- **Оценка точности прогноза:**  
  - ME ≈ −0.0027  
  - RMSE ≈ 0.081  
  - MAE ≈ 0.060  
  - MAPE ≈ 0.64%  
  - MASE ≈ 0.70  
  Низкие значения ошибок и ACF1 = 0.108 подтверждают высокую точность модели и слабую автокорреляцию остатков.

Суммарно, диагностика подтверждает корректность построенной SARIMA-модели и её пригодность для прогнозирования пассажиропотока AirFrance.
```{r}
### Прогноз пассажиропотока AirFrance (с датами на оси X)

library(ggplot2)
library(forecast)

# 1. Прогноз на 12 месяцев
forecast_horizon <- 12
sarima_forecast <- forecast(fit_sarima, h = forecast_horizon)

# 2. Подготовка датафрейма с датами
forecast_dates <- seq(
  from = max(airfrance_data$Date) + 1,
  by = "month",
  length.out = forecast_horizon
)
forecast_df <- data.frame(
  Date = forecast_dates,
  Forecast = exp(sarima_forecast$mean),
  Lo80 = exp(sarima_forecast$lower[,1]),
  Hi80 = exp(sarima_forecast$upper[,1]),
  Lo95 = exp(sarima_forecast$lower[,2]),
  Hi95 = exp(sarima_forecast$upper[,2])
)

# 3. Визуализация прогноза с натуральной шкалой
ggplot(forecast_df, aes(x = Date, y = Forecast)) +
  geom_line(color = "#1f77b4", size = 1) +
  geom_ribbon(aes(ymin = Lo80, ymax = Hi80), fill = "#1f77b4", alpha = 0.2) +
  geom_ribbon(aes(ymin = Lo95, ymax = Hi95), fill = "#1f77b4", alpha = 0.1) +
  labs(
    title = "Прогноз пассажиропотока AirFrance на 12 месяцев",
    subtitle = "Модель SARIMA с учетом логарифмирования и сезонности",
    x = "Дата",
    y = "Количество пассажиров",
    caption = "Линия — прогноз, зоны — 80% и 95% доверительные интервалы"
  ) +
  theme_minimal() +
  scale_x_date(date_labels = "%b %Y", date_breaks = "2 months") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", size = 14)
  )
sarima_forecast_exp <- exp(sarima_forecast$mean)

# 4. Таблица прогнозных значений
forecast_df <- data.frame(
  Month = seq(as.Date(max(airfrance_data$Date)) + 1, by = "month", length.out = forecast_horizon),
  Forecast = sarima_forecast_exp
)

# 5. Вывод таблицы
knitr::kable(forecast_df, digits = 0, caption = "Прогноз пассажиропотока AirFrance (натуральные значения)")
```
#### Прогноз пассажиропотока AirFrance (Март 2016 – Февраль 2017)

# Итоговое заключение и рекомендации
### *Summary *

На основе комплексного анализа временного ряда пассажиропотока (2001–2016 гг.) можно сделать следующие ключевые выводы:

1.  **Устойчивость бизнес-модели-** Компания демонстрирует стабильный восходящий тренд (коэффициент `drift 4e-04`). Это означает, что несмотря на сезонные колебания, фундаментальный спрос на услуги AirFrance органически растет из года в год.
2.  **Прогностическая точность-** Построенная модель **SARIMA(2,0,2)(0,1,1)[12]** успешно прошла тесты на стационарность (ADF и KPSS) и минимизировала информационные критерии (AIC = -749.49). Это гарантирует высокую точность краткосрочного планирования (на 12–24 месяца).
3.  **Управление ресурсами-** Анализ подтвердил «мультипликативную» природу данных: с ростом общего потока растет и амплитуда сезонных пиков. 
    * **Рекомендация-** Планирование мощностей на летний период (июль-август) должно учитывать не средний абсолютный прирост, а процентный шаг, так как «разрыв» между зимним минимумом и летним максимумом будет только увеличиваться.
4.  **Стабильность циклов-** Сезонный паттерн остается неизменным на протяжении 15 лет. Это позволяет автоматизировать процессы маркетинговых акций и графики техобслуживания флота, опираясь на выявленные «точки дна» в феврале и ноябре.

**Результат-** Модель готова к интеграции в систему принятия решений для прогнозирования операционной загрузки авиакомпании.
