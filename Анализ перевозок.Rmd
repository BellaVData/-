---
title: "Анализ временных рядов авиаперевозок AirFrance"
author: "Бэлла Долганова"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    keep_md: false
---
## Executive Summary

Проведён анализ ежемесячных данных о пассажиропотоке AirFrance с целью выявления ключевых закономерностей и построения прогностической модели.

Анализ показал устойчивый восходящий тренд и выраженную годовую сезонность (период 12 месяцев). Пассажиропоток увеличивается в среднем на **≈48 пассажиров ежемесячно**, что свидетельствует о стабильном росте объёма перевозок.

Сезонные колебания имеют относительно постоянную амплитуду, поэтому аддитивная модель декомпозиции наилучшим образом описывает структуру ряда.

Построенные регрессионные модели (с фиктивными переменными и гармоническими компонентами) демонстрируют высокую объясняющую способность (R² = 0.84). Все коэффициенты статистически значимы (p < 0.001), автокорреляция остатков отсутствует, что подтверждает корректность спецификации модели.

Модель может быть использована для краткосрочного прогнозирования и планирования пассажирских перевозок с учётом сезонных пиков и общего тренда роста.

Для анализа используются исторические данные о пассажиропотоке авиакомпании AirFrance. На первом этапе мы загружаем данные и преобразуем текстовые даты в формат, пригодный для статистического анализа.
```{r setup, include=FALSE}
# Настройки и библиотеки
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
library(lubridate)
library(xts)
library(ggplot2)
library(forecast)
library(dplyr)
library(tidyverse)
```{r}
airfrance_data <- read.csv(
  "var7.csv",
  sep = ";",
  stringsAsFactors = FALSE
)
# Формируем дату
airfrance_data$Date <- as.Date(
  paste0(as.character(airfrance_data$Activity.Period), "01"),
  format = "%Y%m%d"
)
airfrance_data$Activity.Period <- NULL
colnames(airfrance_data) <- c("Airline", "Passengers", "Date")

library(DT)
datatable(airfrance_data, options = list(pageLength = 5))
```
На основе очищенных данных мы формируем объект временного ряда с ежемесячной частотой.
```{r}
passengers_ts <- ts(
  airfrance_data$Passengers,
  start = c(year(min(airfrance_data$Date)), month(min(airfrance_data$Date))),
  frequency = 12
)
```
Для понимания структуры ряда проведем классическую аддитивную декомпозицию. Мы разделяем ряд на три составляющие: тренд, сезонность и случайную ошибку (остатки).
На графиках ниже отчетливо виден устойчивый восходящий тренд и выраженная годовая сезонность с повторяющейся амплитудой.
```{r}

additive_model <- decompose(passengers_ts, type = "additive")
plot(additive_model)
```
Для более детального изучения наложим компоненту тренда и сезонности на фактические данные. Это помогает оценить, насколько хорошо выбранная модель описывает реальное поведение ряда.
```{r}
time_vals <- time(additive_model$x)
year_vals <- floor(time_vals)
month_vals <- round((time_vals - year_vals) * 12) + 1

dates_seq <- as.Date(paste(year_vals, month_vals, "01", sep = "-"))

decomp_df <- data.frame(
  Date = dates_seq,
  Observed = as.numeric(additive_model$x),
  Trend = as.numeric(additive_model$trend),
  Seasonal = as.numeric(additive_model$seasonal)
)

ggplot(decomp_df, aes(x = Date)) +
  geom_line(aes(y = Observed, color = "Наблюдаемые данные")) +
  geom_line(aes(y = Trend, color = "Тренд")) +
  geom_line(aes(y = Seasonal + Trend, color = "Тренд + Сезонность")) +
  scale_color_manual(
    name = "Компоненты",
    values = c(
      "Наблюдаемые данные" = "gray25",
      "Тренд" = "cornflowerblue",
      "Тренд + Сезонность" = "darkred"
    )
  ) +
  labs(
    title = "Декомпозиция временного ряда AirFrance",
    x = "Дата",
    y = "Количество пассажиров"
  ) +
  theme_minimal()+
  theme(legend.position = "bottom")
```
Построение автокорреляционной функции необходимо для подтверждения сезонности. Наличие значимых лагов (превышающих синюю пунктирную линию) через каждые 12 месяцев подтверждает строгую годовую цикличность данных.
```{r}
ggAcf(passengers_ts) +
  ggtitle("Автокорреляционная функция (ACF)")
```
Мы используем линейную регрессию, где время выступает как предиктор тренда, а месяцы — как категориальные переменные для учета сезонности.
```{r}
df_ap <- decomp_df %>%
  mutate(
    time_idx = 1:n(),
    month = factor(month(Date))
  )

lm_model <- lm(Observed ~ time_idx + month, data = df_ap)
df_ap$fitted <- fitted(lm_model)
summary(lm_model)

ggplot(df_ap, aes(x = Date)) +
  geom_line(aes(y = Observed), color = "navy") +
  geom_line(aes(y = fitted), color = "brown", linetype = "dashed") +
  labs(
    title = "Факт vs модель (Dummy Variables)",
    x = "Дата",
    y = "Количество пассажиров"
  ) +
  theme_minimal()
```
F-statistic и связанное с ним p-значение подтверждают общую статистическую значимость модели. 
Для более гибкого моделирования сезонных колебаний применим тригонометрические функции (синус и косинус).
```{r}
df_ap <- df_ap %>%
  mutate(t = time_idx)

harmonic_model <- lm(Observed ~ t + sin(2*pi*t/12) + cos(2*pi*t/12), data = df_ap)
df_ap$harmonic_fitted <- fitted(harmonic_model)
```
Из результатов можно сделать следующие выводы:
коэффициент детерминации R2≈0.806R2≈0.806 говорит о высокой объясняющей способности модели;
все коэффициенты статистически значимы (p < 0.001);
среднеквадратичная ошибка остатков около 2062;
высокая F-статистика подтверждает значимость модели;
коэффициент при t положителен (около 47.79), что указывает на рост наблюдаемой переменной с течением времени;
коэффициенты при синусоидальных компонентах отражают выраженную сезонность с периодом 12 месяцев.
Таким образом, гармоническая регрессия успешно моделирует тренд и сезонность, позволяя эффективно анализировать и прогнозировать динамику временного ряда 
```{r}
summary(harmonic_model)

ggplot(df_ap, aes(x = Date)) +
  geom_line(aes(y = Observed), color = "navy") +
  geom_line(aes(y = harmonic_fitted), color = "red4") +
  labs(
    title = "Факт vs модель (Гармоническая регрессия)",
    x = "Дата",
    y = "Количество пассажиров"
  ) +
  theme_minimal()
```
Ряд демонстрирует стабильный рост, что свидетельствует о расширении деятельности компании или росте рынка.Выявлены значимые пики пассажиропотока, связанные с сезонными факторами.Качество моделей: Обе модели показали высокий коэффициент детерминации (R2), что говорит об их адекватности и возможности использования для краткосрочного планирования.